---
title: 'Proof of Concept: Combinatoriality as Entropy Difference'
author: "Chris Bentz"
date: "25/10/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Load libraries
If the libraries are not installed yet, you need to install them using, for example, the command: install.packages("ggplot2"). For the Hrate package this is different, since it comes from github. The devtools library needs to be installed, and then the install_github() function is used.
```{r}
library(stringr)
library(ggplot2)
library(plyr)
library(entropy)
library(ggExtra)
library(ggpubr)
library(gsubfn)
#library(devtools)
#install_github("dimalik/Hrate")
library(Hrate)
library(reshape2)
```

## List files
Create list with all the files in the directory "corpus". 
```{r}
# give file paths to be processed
file.list <- list.files(path = "/home/chris/Github/StringBase/corpus/generated/test", 
                        recursive = T, full.names = T)
print(file.list)
length(file.list)
```

# Stabilization analysis per file
```{r}
# set counter
counter = 0
# set the maximal number of units (n), and the stepsize for stabilization analysis
# (i.e. in steps of how many units are values calculated?)
n = 100
stepsize = 10
# initialize dataframe to append results to
stabilization.df <- data.frame(filename = character(0), subcorpus = character(0), 
                               code = character(0), huni.chars = numeric (0), 
                               hrate.chars = numeric(0), units = numeric(0)) 
# start time
start_time <- Sys.time()
for (file in file.list) 
{
  # basic processing
  # loading textfile
  textfile <- scan(file, what = "char", quote = "", 
                   comment.char = "", encoding = "UTF-8", sep = "\n" , skip = 7) #nmax = 100 
  # nmax is the maximum number of lines to be read
  # remove tabs and parentheses
  textfile <- gsubfn(".", list("\t" = "", "(" = "", ")" = "", "]" = "",
                               "[" = "", "}" = "",  "{" = ""), textfile)
  # remove annotations marked by '<>'
  textfile <- gsub("<.*>","",textfile) 
  # print(head(textfile))
  # get filename
  filename <- basename(file) 
  # print(filename) # for visual inspection
  # get subcorpus category
  subcorpus <- sub("_.*", "", filename)
  # print(subcorpus) # for visual inspection
  # get identification code by removing beginning and end of filename string
  code <- sub(".txt", "", substring(filename, regexpr("_", filename) + 1))
  # print(code) # for visual inspection
  # split the textfile into individual utf-8 characters. The output of strsplit() 
  # is a list, so it needs to be "unlisted"" to get a vector. Note that white spaces    
  # are counted as utf-8 characters here.
  chars <- unlist(strsplit(textfile, ""))
  chars <- chars[1:n] # use only maximally n units
  chars <- chars[!is.na(chars)] # remove NAs for vectors which are already shorter
  # than n
  # chars <- chars[chars != " "] # remove white spaces from character vector
  # define the number of units (i.e. characters) used for analyses (note that k is      
  # always either equal to or smaller than n)
  k = length(chars)
  for (i in 1:(k/stepsize))
  {  
    # unigram entropy estimation
    # calculate unigram entropy for characters
    chars.df <- as.data.frame(table(chars[1:(i*stepsize)]))
    # print(chars.df)
    huni.chars <- entropy(chars.df$Freq, method = "ML", unit = "log2")
    # entropy rate estimation
    # note: the values chosen for max.length and every.word will crucially 
    # impact processing time. max.length = NULL means all units in the file are     
    # considered.
    hrate.chars <- get.estimate(text = chars[1:(i*stepsize)], every.word = 1, 
                                max.length = NULL)  
    # append results to dataframe
    local.df <- data.frame(filename, subcorpus, code, huni.chars, hrate.chars, 
                           units = i*stepsize)
    stabilization.df <- rbind(stabilization.df, local.df)
  }
  # counter
  counter <- counter + 1
  # print(counter)
}
end_time <- Sys.time()
end_time - start_time
print(stabilization.df)
```

# Stabilization plots

Add difference between unigram entropies and entropy rates (delta entropy) as further column.
```{r}
stabilization.df$hdiff <- stabilization.df$huni.chars - stabilization.df$hrate.chars
```

Rename columns, and melt both columns (entropy rate and unigram entropy) in one, in order to plot them on the same panel.
```{r}
stabilization.df.long <- melt(stabilization.df, measure.vars = c("huni.chars", "hrate.chars"),
                                         variable.name = "measure")
```

## Entropy rates and unigram entropies for characters
```{r, fig.width = 5, fig.height = 3, warning = FALSE}
# selected generated data
data.generated <- stabilization.df[stabilization.df$code == "combinatorial_varied" |
                                          stabilization.df$code == "combinatorial_repetitive" |
                                          stabilization.df$code == "non-combinatorial",]
# plot
entropy.generated.plot <- ggplot(data.generated, aes(x = units, y = hrate.chars,
                                                colour = code)) + 
  geom_line(alpha = 0.8, size  = 1.5) +
  geom_point(size = 1, color = "black") +
  ylim(0, 5) +
  theme(legend.position = "right") +
  labs(x = "number of characters", y = "entropy rate (h)") 
  #annotate("text", x = n+25, y = max(data.generated$hrate.chars), label = "abcdefghij...")
  #facet_wrap(~code)
entropy.generated.plot
```

## Safe figure to file
```{r, fig.width = 7, fig.height = 5}
ggsave("Figures/stabilization_entropyDiff_generated_test.pdf", entropy.generated.plot, dpi = 300, 
       scale = 1, device = cairo_pdf)
```

```{r, fig.width = 5, fig.height = 3, warning = FALSE}
# selected natural data
data.natural <- stabilization.df[stabilization.df$code == "chinese" |
                                        stabilization.df$code == "english" |
                                        #stabilization.df$code == "combinatorial" |
                                        #stabilization.df$code == "random" |
                                        #stabilization.df$code == "non-combinatorial" |
                                        stabilization.df$code == "sumerian" |
                                        #stabilization.df$code == "paleolithic (aurignacian)" |
                                        stabilization.df$code == "paleolithic (deer teeth)" |
                                        stabilization.df$code == "paleolithic (mammoth)" ,]
# plot
entropy.natural.plot <- ggplot(data.natural, aes(x = units, y = hrate.chars,
                                                colour = code)) + 
  geom_line(size  = 1) +
  geom_point(size = 1, color = "black") +
  ylim(0, 5) +
  #scale_linetype_manual(values = c("dashed", "dotted")) +
  #theme(legend.position = "bottom") +
  labs(x = "number of characters", y = "entropy rate (h)") 
  # facet_wrap(~code)
entropy.natural.plot
```

## Safe figure to file
```{r, fig.width = 7, fig.height = 5}
ggsave("Figures/stabilization_entropyDiff_natural_test.pdf", entropy.natural.plot, dpi = 300, 
       scale = 1, device = cairo_pdf)
```

## Entropy Difference 
```{r, fig.width = 5, fig.height = 3, warning = FALSE}
entropy.diff.plot <- ggplot(data.natural, aes(x = units, y = hdiff,
                                                   colour = code)) +
  geom_line(size  = 1) +
  geom_point(size = 1, shape = 15, color = "black") +
  theme(legend.position = "none") +
  labs(x = "number of characters", y = "entropy difference (Î”E)")#+
  #facet_wrap(~code)
entropy.diff.plot
```

## Combined Plots
```{r, fig.width = 10, fig.height = 3}
plots.combined <- ggarrange(entropy.generated.plot, entropy.natural.plot,
                    labels = c("a)", "b)"),
                    ncol = 2, nrow = 1, widths = c(1, 1))
plots.combined
```
## Safe figure to file
```{r, fig.width = 10, fig.height = 3}
ggsave("Figures/stabilization_entropyRate_natural_test.pdf", plots.combined, dpi = 300, 
       scale = 1, device = cairo_pdf)
```

# Shuffling Experiment: Differences for entropy rates of shuffled and original texts

## Stabilization plot for entropy rates
```{r, fig.width = 8, fig.height = 5, warning = FALSE}
# select original data
data.original <- stabilization.df[stabilization.df$code == "chinese" |
                                        #stabilization.df$code == "combinatorial" |
                                        stabilization.df$code == "english" |
                                        stabilization.df$code == "sumerian" |
                                        #stabilization.df$code == "random" |
                                        stabilization.df$code == "paleolithic (aurignacian)" ,]
                                        #stabilization.df$code == "paleolithic (deer teeth)" |
                                        #stabilization.df$code == "paleolithic (mammoth)"
# select shuffled data
data.shuffled <- stabilization.df[stabilization.df$code == "chinese_shuffled" |
                                        #stabilization.df$code == "combinatorial_shuffled" |
                                        stabilization.df$code == "english_shuffled" |
                                        #stabilization.df$code == "random_shuffled" |
                                        stabilization.df$code == "sumerian_shuffled" |
                                        stabilization.df$code == "paleolithic (aurignacian)_shuffled",]
                                        #stabilization.df$code == "paleolithic (deer teeth)_shuffled" |
                                        #stabilization.df$code == "paleolithic (mammoth)_shuffled"
# remove "Shuffled" in code
data.shuffled$code <- sub("_shuffled", "", data.shuffled$code)

# add columns with shuffling information
data.original$type <- rep("original", nrow(data.original))
data.shuffled$type <- rep("shuffled", nrow(data.shuffled))

# combine data frames
data.combined <- rbind(data.original, data.shuffled)

# plot
entropy.shuffled.plot <- ggplot(data.combined, aes(x = units, y = hrate.chars,
                                                colour = code, shape = type)) + 
  geom_line(size  = 1) +
  geom_point(size = 1, color = "black") +
  #scale_linetype_manual(values = c("dashed", "dotted")) +
  #theme(legend.position = "bottom") +
  labs(x = "number of characters", y = "entropy") +
  facet_wrap(~code)
entropy.shuffled.plot
```

## Safe figure to file
```{r, fig.width = 10, fig.height = 3}
ggsave("Figures/stabilization_entropyDiff_shuffled_test.pdf", entropy.shuffled.plot, dpi = 300, 
       scale = 1, device = cairo_pdf)
```
